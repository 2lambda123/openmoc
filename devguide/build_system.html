<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>3. Python Build System &mdash; OpenMOC Documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="OpenMOC Documentation" href="../index.html" />
    <link rel="up" title="Developer’s Guide" href="index.html" />
    <link rel="next" title="4. Debugging OpenMOC" href="debugging.html" />
    <link rel="prev" title="2. Simplified Wrapper Interface Generator (SWIG)" href="swig.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="debugging.html" title="4. Debugging OpenMOC"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="swig.html" title="2. Simplified Wrapper Interface Generator (SWIG)"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">OpenMOC Documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Developer&#8217;s Guide</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="python-build-system">
<span id="build-sytem"></span><h1>3. Python Build System<a class="headerlink" href="#python-build-system" title="Permalink to this headline">¶</a></h1>
<p>OpenMOC is built and installed using the Python <a class="reference external" href="http://docs.python.org/2/library/distutils.html">distutils</a> package, which is a standard package provided with all Python distributions. Some developers will find this to be an adjustment since this stands in contrast to the legacy <a class="reference external" href="http://www.gnu.org/software/make/">make</a> and <a class="reference external" href="http://www.cmake.org/">cmake</a> build systems used by many scientific simulation codes. The following sections will describe how a developer can interact with the build system for configuration management.</p>
<div class="section" id="configuration-file">
<span id="id1"></span><h2>3.1. Configuration File<a class="headerlink" href="#configuration-file" title="Permalink to this headline">¶</a></h2>
<p>The primary options for the build and installation of OpenMOC are defined in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file. In particular, <tt class="file docutils literal"><span class="pre">config.py</span></tt> creates the <a class="reference external" href="http://docs.python.org/2/extending/building.html">C/C++ Extensions</a> using distutils in the <tt class="docutils literal"><span class="pre">configuration</span></tt> class. The <tt class="docutils literal"><span class="pre">Extension</span></tt> class in the <tt class="docutils literal"><span class="pre">distutils.extension</span></tt> module defines all of the source code and compiler and linker options to create a <a class="reference external" href="http://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html">shared library</a> which can be imported into Python as module. The class attributes for the <tt class="docutils literal"><span class="pre">configuration</span></tt> class encapsulate the build options specified by the user at compile time (see <a class="reference internal" href="../usersguide/install.html#build-configuration-options"><em>Build Configuration Options</em></a>) and are itemized in <a class="reference internal" href="#table-configuration-attributes"><em>Table 1</em></a>.</p>
<table border="1" class="docutils" id="table-configuration-attributes">
<colgroup>
<col width="27%" />
<col width="25%" />
<col width="48%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Class Attribute</th>
<th class="head">Type</th>
<th class="head">Default Value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">cc</span></tt></td>
<td>string</td>
<td>&#8216;gcc&#8217;</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">fp</span></tt></td>
<td>string</td>
<td>&#8216;single&#8217;</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">cpp_compilers</span></tt></td>
<td>list of strings</td>
<td>[]</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">fp_precision</span></tt></td>
<td>list of string</td>
<td>[]</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">with_ccache</span></tt></td>
<td>boolean</td>
<td>False</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">debug_mode</span></tt></td>
<td>boolean</td>
<td>False</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">with_cuda</span></tt></td>
<td>boolean</td>
<td>False</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">with_numpy</span></tt></td>
<td>boolean</td>
<td>True</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">sources</span></tt></td>
<td>dictionary of strings</td>
<td>C/C++/CUDA source files flags for eac  <tt class="docutils literal"><span class="pre">Extension</span></tt> object</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">compiler_flags</span></tt></td>
<td>dictionary of strings</td>
<td>Flags for each <tt class="docutils literal"><span class="pre">Extension</span></tt> object</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">linker_flags</span></tt></td>
<td>dictionary of strings</td>
<td>Flags for each <tt class="docutils literal"><span class="pre">Extension</span></tt> object</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">shared_libraries</span></tt></td>
<td>dictionary of strings</td>
<td>Libraries for each <tt class="docutils literal"><span class="pre">Extension</span></tt> object</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">library_directories</span></tt></td>
<td>dictionary of strings</td>
<td>Libraries for each <tt class="docutils literal"><span class="pre">Extension</span></tt> object</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">include_directories</span></tt></td>
<td>dictionary of strings</td>
<td>Includes for each <tt class="docutils literal"><span class="pre">Extension</span></tt> object</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">macros</span></tt></td>
<td>dictionary of strings</td>
<td>Macros for each <tt class="docutils literal"><span class="pre">Extension</span></tt> object</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">extensions</span></tt></td>
<td>list of <tt class="docutils literal"><span class="pre">Extension</span></tt> objects</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p><strong>Table 1</strong>: Attributes for the <tt class="docutils literal"><span class="pre">configuration</span></tt> class.</p>
<p>The class attributes each have default values corresponding to the configuration needed to build and install the <tt class="docutils literal"><span class="pre">openmoc</span></tt> module. The <tt class="file docutils literal"><span class="pre">OpenMOC/setup.py</span></tt> file instantiates a <tt class="docutils literal"><span class="pre">configuration</span></tt> class object and redefines the class attributes based on the command line options given at runtime. This process is discussed in greater detail in the <a class="reference internal" href="#setup-file"><em>Setup File</em></a> section.</p>
<p>Once the build options have been defined for the <tt class="docutils literal"><span class="pre">configuration</span></tt> class, the <tt class="file docutils literal"><span class="pre">setup.py</span></tt> calls the <tt class="docutils literal"><span class="pre">setup_extension_modules(...)</span></tt> class method which instantiates one or more <tt class="docutils literal"><span class="pre">Extension</span></tt> class objects for each Python module the user wishes to build and install.</p>
<p>For example, the following command would build and install the <tt class="docutils literal"><span class="pre">openmoc</span></tt> module using the default compiler (gcc) and with double precision:</p>
<div class="highlight-python"><div class="highlight"><pre>python setup.py install --user --with-dp
</pre></div>
</div>
<p>Users may build and install more than one OpenMOC module at once with the appropriate command line options. For example, the following command would build and install the <tt class="docutils literal"><span class="pre">openmoc</span></tt> module with default compiler (gcc), as well as the <tt class="docutils literal"><span class="pre">openmoc.intel.double</span></tt> module, each with double precision:</p>
<div class="highlight-python"><div class="highlight"><pre>python setup.py install --user --with-intel --with-dp
</pre></div>
</div>
<p>Similarly, the following command would build and install the <tt class="docutils literal"><span class="pre">openmoc</span></tt> module with default compiler (gcc), as well was the <tt class="docutils literal"><span class="pre">openmoc.cuda.single</span></tt> module, each with single precision and <a class="reference external" href="http://en.wikipedia.org/wiki/Debug_symbol">debug symbols</a>:</p>
<div class="highlight-python"><div class="highlight"><pre>python setup.py install --user --with-cuda --with-sp --debug-mode
</pre></div>
</div>
</div>
<div class="section" id="setup-file">
<span id="id2"></span><h2>3.2. Setup File<a class="headerlink" href="#setup-file" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="file docutils literal"><span class="pre">/OpenMOC/setup.py</span></tt> file is used to execute the build and installation process for OpenMOC. The methodology and implementation to handle command line options, custom compilers and linkers, and the build and installation phase.</p>
<div class="section" id="command-line-options">
<h3>3.2.1. Command Line Options<a class="headerlink" href="#command-line-options" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="file docutils literal"><span class="pre">setup.py</span></tt> file first defines the <tt class="docutils literal"><span class="pre">custom_install</span></tt> class to override (subclass) the <tt class="docutils literal"><span class="pre">install</span></tt> class in the <tt class="docutils literal"><span class="pre">distutils.command.install</span></tt> module. In particular, the <tt class="docutils literal"><span class="pre">initialize_options(...)</span></tt> class method is used to initialize the default build options for the <tt class="docutils literal"><span class="pre">configuration</span></tt> class (see <a class="reference internal" href="#configuration-file"><em>Configuration File</em></a>). The <tt class="docutils literal"><span class="pre">finalize_options(...)</span></tt> routine extracts the command line options, initializes the corresponding <tt class="docutils literal"><span class="pre">configuration</span></tt> class attributes, and calls the <tt class="docutils literal"><span class="pre">configuration.setup_extension_modules()</span></tt> class method to create the distutils <tt class="docutils literal"><span class="pre">Extension</span></tt> object.</p>
</div>
<div class="section" id="custom-compilers-and-linkers">
<h3>3.2.2. Custom Compilers and Linkers<a class="headerlink" href="#custom-compilers-and-linkers" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">customize_compiler(...)</span></tt> method is used to override the <tt class="docutils literal"><span class="pre">_compile(...)</span></tt> method in distutils to allow for compilation with a variety of toolchains (e.g., <tt class="docutils literal"><span class="pre">gcc</span></tt>, <tt class="docutils literal"><span class="pre">icpc</span></tt>, etc.). As presently implemented, the method chooses a compiler based on the macro definitions in the compile line (i.e, <tt class="docutils literal"><span class="pre">gcc</span></tt> for the macro definition <span class="target" id="index-0"></span><tt class="xref std std-envvar docutils literal"><span class="pre">-DGNU</span></tt>). Likewise, the <tt class="docutils literal"><span class="pre">customize_linker(...)</span></tt> method is used to override the <tt class="docutils literal"><span class="pre">link(...)</span></tt> method in distutils to allow for linking with a variety of toolchains (e.g., <tt class="docutils literal"><span class="pre">g++</span></tt>, <tt class="docutils literal"><span class="pre">icpc</span></tt>, etc.). The method chooses an executable for linking based on the target shared library name.</p>
<p>The <tt class="docutils literal"><span class="pre">custom_build_ext(...)</span></tt> class is used to override (subclass) the <tt class="docutils literal"><span class="pre">build_ext</span></tt> class in the <tt class="docutils literal"><span class="pre">distutils.command</span></tt> module. In particular, this class overrides the <tt class="docutils literal"><span class="pre">build_extension(...)</span></tt> method and uses it for the following:</p>
<ul class="simple">
<li>Inject the <tt class="docutils literal"><span class="pre">customize_compiler(...)</span></tt> and <tt class="docutils literal"><span class="pre">customize_linker(...)</span></tt> methods into the <tt class="docutils literal"><span class="pre">build_ext</span></tt> class</li>
<li>Call SWIG to generate Python wrappers for the C/C++ source code.</li>
</ul>
</div>
<div class="section" id="building-and-installation">
<h3>3.2.3. Building and Installation<a class="headerlink" href="#building-and-installation" title="Permalink to this headline">¶</a></h3>
<p>In the final step, the <tt class="docutils literal"><span class="pre">setup(...)</span></tt> method from the <tt class="docutils literal"><span class="pre">distutils.core</span></tt> module is called in the <tt class="docutils literal"><span class="pre">setup.py</span></tt> file. The <tt class="docutils literal"><span class="pre">setup(...)</span></tt> method receives the list of the <tt class="docutils literal"><span class="pre">Extension</span></tt> class objects and builds and installs each one as a shared library in the <tt class="file docutils literal"><span class="pre">/home/&lt;username&gt;/.local/lib/python-x.x/site-packages/</span></tt> directory. On a Unix-based machine, the shared library for the default <tt class="docutils literal"><span class="pre">openmoc</span></tt> module will be <tt class="docutils literal"><span class="pre">_openmoc.so</span></tt>. The Python modules in OpenMOC (e.g., <tt class="docutils literal"><span class="pre">openmoc.materialize</span></tt>, <tt class="docutils literal"><span class="pre">openmoc.plotter</span></tt>, etc.) will be installed in the <tt class="file docutils literal"><span class="pre">/home/&lt;username&gt;/.local/lib/python-x.x/site-packages/</span></tt> directory.</p>
</div>
</div>
<div class="section" id="swig-interface-files">
<h2>3.3. SWIG Interface Files<a class="headerlink" href="#swig-interface-files" title="Permalink to this headline">¶</a></h2>
<p>OpenMOC uses the SWIG system (discussed in <a class="reference internal" href="swig.html#swig"><em>Simplified Wrapper Interface Generator</em></a>) to generate Python bindings for classes and routines in the compiled C/C++ source code. In order for SWIG to work, the C/C++ header files <strong>must contain all of the class and function prototypes.</strong> Furthermore, the headers files must be exposed to SWIG through a <a class="reference external" href="http://www.swig.org/Doc2.0/SWIGDocumentation.html#Introduction_nn6">SWIG interface file</a> (see <a class="reference internal" href="swig.html#swig-input"><em>SWIG Input</em></a>). The interface files are located in the <tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/...</span></tt> directory and use a <tt class="docutils literal"><span class="pre">.i</span></tt> extension. There are different interface files for the different C/C++ extension modules which may be built for Python (e.g. with different compilers). <a class="reference internal" href="#table-openmoc-swig-files"><em>Table 2</em></a> tabulates all of the interface files in OpenMOC, the Python module that would be built, and the shell command that would be used to build the module.</p>
<table border="1" class="docutils" id="table-openmoc-swig-files">
<colgroup>
<col width="41%" />
<col width="16%" />
<col width="43%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">File</th>
<th class="head">Python Module</th>
<th class="head">Shell Build Command</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/openmoc.i</span></tt></td>
<td><tt class="docutils literal"><span class="pre">openmoc</span></tt></td>
<td><strong class="command">python setup.py install &#8211;user</strong></td>
</tr>
<tr class="row-odd"><td><tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/gnu/single/openmoc_gnu_single.i</span></tt></td>
<td><tt class="docutils literal"><span class="pre">openmoc.gnu.single</span></tt></td>
<td><strong class="command">python setup.py install &#8211;user &#8211;with-gcc -with-sp</strong></td>
</tr>
<tr class="row-even"><td><tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/gnu/double/openmoc_gnu_double.i</span></tt></td>
<td><tt class="docutils literal"><span class="pre">openmoc.gnu.double</span></tt></td>
<td><strong class="command">python setup.py install &#8211;user &#8211;with-gcc &#8211;with-dp</strong></td>
</tr>
<tr class="row-odd"><td><tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/intel/single/openmoc_intel_single.i</span></tt></td>
<td><tt class="docutils literal"><span class="pre">openmoc.intel.single</span></tt></td>
<td><strong class="command">python setup.py install &#8211;user &#8211;with-icpc &#8211;with-sp</strong></td>
</tr>
<tr class="row-even"><td><tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/intel/double/openmoc_intel_double.i</span></tt></td>
<td><tt class="docutils literal"><span class="pre">openmoc.intel.double</span></tt></td>
<td><strong class="command">python setup.py install &#8211;user &#8211;with-icpc &#8211;with-dp</strong></td>
</tr>
<tr class="row-odd"><td><tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/bgq/single/openmoc_bgq_single.i</span></tt></td>
<td><tt class="docutils literal"><span class="pre">openmoc.bgq.single</span></tt></td>
<td><strong class="command">python setup.py install &#8211;user &#8211;with-bgxlc &#8211;with-sp</strong></td>
</tr>
<tr class="row-even"><td><tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/bgq/double/openmoc_bgq_double.i</span></tt></td>
<td><tt class="docutils literal"><span class="pre">openmoc.bgq.double</span></tt></td>
<td><strong class="command">python setup.py install &#8211;user &#8211;with-bgxlc &#8211;with-dp</strong></td>
</tr>
<tr class="row-odd"><td><tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/cuda/single/openmoc_cuda.i</span></tt></td>
<td><tt class="docutils literal"><span class="pre">openmoc.cuda</span></tt></td>
<td><strong class="command">python setup.py install &#8211;user &#8211;with-cuda</strong></td>
</tr>
<tr class="row-even"><td><tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/cuda/single/openmoc_cuda_single.i</span></tt></td>
<td><tt class="docutils literal"><span class="pre">openmoc.cuda.single</span></tt></td>
<td><strong class="command">python setup.py install &#8211;user &#8211;with-cuda &#8211;with-sp</strong></td>
</tr>
<tr class="row-odd"><td><tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/cuda/double/openmoc_cuda_double.i</span></tt></td>
<td><tt class="docutils literal"><span class="pre">openmoc.cuda.double</span></tt></td>
<td><strong class="command">python setup.py install &#8211;user &#8211;with-cuda &#8211;with-dp</strong></td>
</tr>
</tbody>
</table>
<p><strong>Table 2</strong>: SWIG interface files for OpenMOC modules.</p>
<p>The <a class="reference internal" href="#add-source-file"><em>Add a C/C++ Source File</em></a> section discusses how to add new C/C++ source files and expose them to SWIG through the interface files. The interface files are useful for a variety of auxiliary purposes as well, most notably the specifications to input and retrieve <a class="reference external" href="http://www.numpy.org">NumPy</a> data from the compiled C/C++ shared library object(s) from Python (see <a class="reference internal" href="swig.html#numpy-typemaps"><em>NumPy Typemaps</em></a>).</p>
</div>
<div class="section" id="common-modifications">
<h2>3.4. Common Modifications<a class="headerlink" href="#common-modifications" title="Permalink to this headline">¶</a></h2>
<p>The following sections cover some of the most common modifications and extensions that many developers need as they incorprate new features into OpenMOC, including how to add new C/C++ source files, Python modules, C/C++ extension modules and more.</p>
<div class="section" id="add-a-c-c-source-file">
<span id="add-source-file"></span><h3>3.4.1. Add a C/C++ Source File<a class="headerlink" href="#add-a-c-c-source-file" title="Permalink to this headline">¶</a></h3>
<p>There are three steps which must be taken to integrate a new source C/C++ file into the build system for OpenMOC.</p>
<ol class="arabic simple">
<li>Include source header file (<tt class="docutils literal"><span class="pre">.h</span></tt>) in top of SWIG interface file (e.g. <tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/openmoc.i</span></tt>) using the following code syntax:</li>
</ol>
<blockquote>
<div><div class="highlight-none"><div class="highlight"><pre>#include &quot;../src/MyFile.h&quot;
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Include source header file (<tt class="docutils literal"><span class="pre">.h</span></tt>) in bottom of SWIG interface file (e.g. <tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/openmoc.i</span></tt>) using the following code syntax:</li>
</ol>
<blockquote>
<div><div class="highlight-none"><div class="highlight"><pre>%include ../src/MyFile.h
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li>Append the source implementation file (<tt class="docutils literal"><span class="pre">.c</span></tt>, <tt class="docutils literal"><span class="pre">.cpp</span></tt>, <tt class="docutils literal"><span class="pre">.cu</span></tt>, etc.) to the <tt class="docutils literal"><span class="pre">sources</span></tt> attribute for the <tt class="docutils literal"><span class="pre">configuration</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file (see <a class="reference internal" href="#configuration-file"><em>Configuration File</em></a>).</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Changes to the C/C++ source files are not reflected until the OpenMOC has been reinstalled.</p>
</div>
</div>
<div class="section" id="add-a-python-module">
<h3>3.4.2. Add a Python Module<a class="headerlink" href="#add-a-python-module" title="Permalink to this headline">¶</a></h3>
<p>OpenMOC includes several Python modules by default (i.e., <tt class="docutils literal"><span class="pre">openmoc.materialize</span></tt>, <tt class="docutils literal"><span class="pre">openmoc.plotter</span></tt>, etc.). These modules are Python files located in the <tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc</span></tt> directory and are installed each time the C/C++ extension module(s) for OpenMOC are built and installed. For example, to create the <tt class="docutils literal"><span class="pre">openmoce.mymodule`</span> <span class="pre">module,</span> <span class="pre">create</span> <span class="pre">the</span> <span class="pre">:file:`mymodule.py`</span> <span class="pre">file</span> <span class="pre">in</span> <span class="pre">the</span> <span class="pre">:file:`OpenMOC/openmoc`</span> <span class="pre">directory.</span> <span class="pre">You</span> <span class="pre">must</span> <span class="pre">then</span> <span class="pre">append</span> <span class="pre">the</span> <span class="pre">name</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">module</span> <span class="pre">(*i.e.*,</span> <span class="pre">``openmoc.mymodule</span></tt>) to the <tt class="docutils literal"><span class="pre">packages</span></tt> list class attribute in the <tt class="docutils literal"><span class="pre">configuration</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Changes to a Python module are not reflected until OpenMOC has been reinstalled.</p>
</div>
</div>
<div class="section" id="add-a-compiler-flag">
<h3>3.4.3. Add a Compiler Flag<a class="headerlink" href="#add-a-compiler-flag" title="Permalink to this headline">¶</a></h3>
<p>In order to add a new compiler flag to OpenMOC, simply append it as a Python string to the <tt class="docutils literal"><span class="pre">compiler_flags</span></tt> attribute of the <tt class="docutils literal"><span class="pre">configuration</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file. The <tt class="docutils literal"><span class="pre">compiler_flags</span></tt> attribute is a Python dictionary (see <a class="reference internal" href="#configuration-file"><em>Configuration File</em></a>) with keys for each compiler supported by the build system. Simply choose which compiler the compiler flag is applicable to and append the string to the list corresponding to that key. For example, to add the <em class="xref std std-option">-falign-functions</em> flag for <tt class="docutils literal"><span class="pre">gcc</span></tt>, append &#8216;-falign-functions&#8217; to the list in <tt class="docutils literal"><span class="pre">compiler_flags</span></tt> corresponding to &#8216;gcc&#8217;.</p>
</div>
<div class="section" id="add-a-linker-flag">
<h3>3.4.4. Add a Linker Flag<a class="headerlink" href="#add-a-linker-flag" title="Permalink to this headline">¶</a></h3>
<p>In order to add a new linker flag to OpenMOC, simply append it as a Python string to the <tt class="docutils literal"><span class="pre">linker_flags</span></tt> attribute of the <tt class="docutils literal"><span class="pre">configuration</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file. The <tt class="docutils literal"><span class="pre">linker_flags</span></tt> attribute is a Python dictionary (see <a class="reference internal" href="#configuration-file"><em>Configuration File</em></a>) with keys for each compiler supported by the build system. Simply choose which compiler the linker flag is applicable to and append the string to the list corresponding to that key. For example, to add the <em class="xref std std-option">-dynamiclib</em> flag for <tt class="docutils literal"><span class="pre">gcc</span></tt>, append &#8216;-dynamiclib&#8217; to the list in <tt class="docutils literal"><span class="pre">linker_flags</span></tt> corresponding to &#8216;gcc&#8217;.</p>
</div>
<div class="section" id="add-a-library-directory">
<h3>3.4.5. Add a Library Directory<a class="headerlink" href="#add-a-library-directory" title="Permalink to this headline">¶</a></h3>
<p>In order to add a new library directory to OpenMOC, simply append it as a Python string to the <tt class="docutils literal"><span class="pre">library_directories</span></tt> attribute of the <tt class="docutils literal"><span class="pre">configuration</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file. The <tt class="docutils literal"><span class="pre">library_directories</span></tt> attribute is a Python dictionary (see <a class="reference internal" href="#configuration-file"><em>Configuration File</em></a>) with keys for each compiler supported by the build system. Simply choose which compiler the library directory is applicable to and append the string to the list corresponding to that key. For example, to add the <em class="xref std std-option">/usr/local/cuda/lib</em> include directory for <tt class="docutils literal"><span class="pre">nvcc</span></tt>, append &#8216;/usr/local/cuda/lib&#8217; to the list in <tt class="docutils literal"><span class="pre">library_directories</span></tt> corresponding to &#8216;gcc&#8217;.</p>
<p>You do not need to add a library directory if it is already in included in your <span class="target" id="index-1"></span><tt class="xref std std-envvar docutils literal"><span class="pre">LD_LIBRARY_PATH</span></tt> environment variable. You can check if the directory is included with the following command from a Linux or Mac bash console:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$LD_LIBRARY_PATH</span>
</pre></div>
</div>
<p>To include the directory in <span class="target" id="index-2"></span><tt class="xref std std-envvar docutils literal"><span class="pre">LD_LIBRARY_PATH</span></tt> instead of the <tt class="file docutils literal"><span class="pre">config.py</span></tt> file, use the following command from a Linux or Mac bash console:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/my/library/directory/here:<span class="nv">$LD_LIBRARY_PATH</span>
</pre></div>
</div>
</div>
<div class="section" id="add-an-include-directory">
<h3>3.4.6. Add an Include Directory<a class="headerlink" href="#add-an-include-directory" title="Permalink to this headline">¶</a></h3>
<p>In order to add a new include directory to OpenMOC, simply append it as a Python string to the <tt class="docutils literal"><span class="pre">include_directories</span></tt> attribute of the <tt class="docutils literal"><span class="pre">configuration</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file. The <tt class="docutils literal"><span class="pre">include_directories</span></tt> attribute is a Python dictionary (see <a class="reference internal" href="#configuration-file"><em>Configuration File</em></a>) with keys for each compiler supported by the build system. Simply choose which compiler the include directory is applicable to and append the string to the list corresponding to that key. For example, to add the <em class="xref std std-option">/usr/local/cuda/include</em> include directory for <tt class="docutils literal"><span class="pre">gcc</span></tt>, append &#8216;/usr/local/cuda/include&#8217; to the list in <tt class="docutils literal"><span class="pre">include_directories</span></tt> corresponding to &#8216;gcc&#8217;.</p>
</div>
<div class="section" id="link-a-shared-library">
<h3>3.4.7. Link a Shared Library<a class="headerlink" href="#link-a-shared-library" title="Permalink to this headline">¶</a></h3>
<p>In order to link OpenMOC to a shared library, simply append the library name as a Python string to the <tt class="docutils literal"><span class="pre">shared_libraries</span></tt> attribute of the <tt class="docutils literal"><span class="pre">configuration</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file. The <tt class="docutils literal"><span class="pre">shared_libraries</span></tt> attribute is a Python dictionary (see <a class="reference internal" href="#configuration-file"><em>Configuration File</em></a>) with keys for each compiler supported by the build system. Simply choose which compiler the shared library is applicable to and append the string to the list corresponding to that key. For example, to add the <em class="xref std std-option">gomp</em> shared library for <tt class="docutils literal"><span class="pre">gcc</span></tt>, append &#8216;gomp&#8217; to the list in <tt class="docutils literal"><span class="pre">shared_libraries</span></tt> corresponding to &#8216;gcc&#8217;.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Do <strong>NOT</strong> prepend &#8220;l&#8221; or &#8220;lib&#8221; to the shared library as is typical for most compilers. Python distutils will automatically do this for you.</p>
</div>
</div>
<div class="section" id="add-a-macro-definition">
<h3>3.4.8. Add a Macro Definition<a class="headerlink" href="#add-a-macro-definition" title="Permalink to this headline">¶</a></h3>
<p>In order to add a C/C++ pre-processing macro option to OpenMOC, simply append the macro as a Python tuple to the <tt class="docutils literal"><span class="pre">macros</span></tt> attribute of the <tt class="docutils literal"><span class="pre">configuration</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file. The <tt class="docutils literal"><span class="pre">macros</span></tt> attribute is a Python dictionary (see <a class="reference internal" href="#configuration-file"><em>Configuration File</em></a>) with keys for each compiler supported by the build system. Simply choose which compiler the macro is applicable to and append the tuple to the list corresponding to that key. For example, to add the <em class="xref std std-option">METHOD=fast</em> macro for <tt class="docutils literal"><span class="pre">gcc</span></tt>, append the <tt class="docutils literal"><span class="pre">('METHOD',</span> <span class="pre">'fast')</span></tt> tuple to the list in <tt class="docutils literal"><span class="pre">macros</span></tt> corresponding to &#8216;gcc&#8217;.</p>
</div>
</div>
<div class="section" id="add-a-c-c-extension-module">
<h2>3.5. Add a C/C++ Extension Module<a class="headerlink" href="#add-a-c-c-extension-module" title="Permalink to this headline">¶</a></h2>
<p>Many developers may write new C/C++ source code which performs some new physics or compute-intensive task. In some cases, the new code may be applicable for some users but less desirable for others. Alternatively, the code may only be applicable for certain types of simulations and less so for others. In these situations, it may be best to include the new C/C++ source code as a new extension module to OpenMOC. The following section discuses the steps which must be taken (in order) to incorporate a new extension module into OpenMOC&#8217;s build system.</p>
<div class="section" id="create-new-swig-interface-file">
<h3>3.5.1. Create New SWIG Interface File<a class="headerlink" href="#create-new-swig-interface-file" title="Permalink to this headline">¶</a></h3>
<p>The first step to creating a new extension module is to create new SWIG interface file for the module. Interface files and some SWIG capabilities are discussed in more detail in <a class="reference internal" href="swig.html#swig"><em>Simplified Wrapper Interface Generator</em></a>. In this section, it suffices to say that if you wish to create the <tt class="docutils literal"><span class="pre">openmoc.submodule</span></tt> extension module, you will need to create the <tt class="file docutils literal"><span class="pre">openmoc_submodule.i</span></tt> interface file akin to what is illustrated below:</p>
<div class="highlight-none"><div class="highlight"><pre>%module openmoc_submodule

%{

  #define SWIG_FILE_WITH_INIT

  /* Include all header files to wrap here */
  #include &quot;first_source_file.h&quot;
  ...
  #include &quot;last_source_file.h&quot;
%}

/* Include all header files to wrap here */
%include first_source_file.h
...
%include last_source_file.h
</pre></div>
</div>
</div>
<div class="section" id="add-source-files">
<h3>3.5.2. Add Source Files<a class="headerlink" href="#add-source-files" title="Permalink to this headline">¶</a></h3>
<p>Second, you need to create a new entry in the <tt class="docutils literal"><span class="pre">sources</span></tt> dictionary attribute for the <tt class="docutils literal"><span class="pre">configuration</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file. The entry should contain a list of the C/C++ source files to compile, including the <a class="reference internal" href="swig.html#swig-input"><em>SWIG wrap file</em></a>. An example of what might be appended to the <tt class="docutils literal"><span class="pre">configuration</span></tt> class is illustrated below</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Store list of C/C++ source files for the module</span>
<span class="n">sources</span><span class="p">[</span><span class="s">&#39;submodule&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;submodule_wrap.cpp&#39;</span><span class="p">,</span>
                        <span class="s">&#39;first_source_file.cpp&#39;</span><span class="p">,</span>
                        <span class="o">...</span>
                        <span class="s">&#39;last_source_file.cpp&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="add-build-options">
<span id="id3"></span><h3>3.5.3. Add Build Options<a class="headerlink" href="#add-build-options" title="Permalink to this headline">¶</a></h3>
<p>Next, you must create new entries in the <tt class="docutils literal"><span class="pre">configuration</span></tt> class attributes for compiler flags, linker flags, etc. in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file. Each of these build options is stored as a Python dictionary. Some of your build options may be identical to those for one or more of the main extension modules for OpenMOC. An example of what might be appended to the <tt class="docutils literal"><span class="pre">configuration</span></tt> class is illustrated below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Store build options for the module</span>

<span class="c"># Compiler flags</span>
<span class="n">compiler_flags</span><span class="p">[</span><span class="s">&#39;submodule&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-first-option&#39;</span><span class="p">,</span> <span class="o">...</span> <span class="p">,</span> <span class="s">&#39;-last-option&#39;</span><span class="p">]</span>

<span class="c"># Linker flags</span>
<span class="n">linker_flags</span><span class="p">[</span><span class="s">&#39;submodule&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-first-option&#39;</span><span class="p">,</span> <span class="o">...</span> <span class="p">,</span> <span class="s">&#39;-last-option&#39;</span><span class="p">]</span>

<span class="c"># Shared libraries (do not prepend &quot;l&quot; or &quot;lib&quot;)</span>
<span class="n">shared_libraries</span><span class="p">[</span><span class="s">&#39;submodule&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-firstlib&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="s">&#39;-lastlib&#39;</span><span class="p">]</span>

<span class="c"># Library directories (if not set in LD_LIBRARY_PATH)</span>
<span class="n">library_directories</span><span class="p">[</span><span class="s">&#39;submodule&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/first/library/directory&#39;</span><span class="p">,</span>
                                    <span class="o">...</span>
                                    <span class="s">&#39;/second/library/directory&#39;</span><span class="p">]</span>

<span class="c"># Include directories</span>
<span class="n">include_directories</span><span class="p">[</span><span class="s">&#39;submodule&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/first/include/directory&#39;</span><span class="p">,</span>
                                    <span class="o">...</span>
                                    <span class="s">&#39;/second/include/directory&#39;</span><span class="p">]</span>


<span class="c"># Define new macros as with tuples for each</span>
<span class="n">macros</span><span class="p">[</span><span class="s">&#39;submodule&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;FIRST_MACRO&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                       <span class="o">...</span>
                       <span class="p">(</span><span class="s">&#39;LAST_MACRO&#39;</span><span class="p">,</span> <span class="mi">42</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="section" id="add-a-build-option">
<h3>3.5.4. Add a Build Option<a class="headerlink" href="#add-a-build-option" title="Permalink to this headline">¶</a></h3>
<p>In order to make your <tt class="docutils literal"><span class="pre">openmoc.submodule</span></tt> extension module an optional module for OpenMOC, you need to add a build option (or flag). The build options are defined and interpreted by the <tt class="docutils literal"><span class="pre">custom_install</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/setup.py</span></tt> file. There are three primary steps which must be taken in order to add a build option.</p>
<ol class="arabic">
<li><p class="first">First, append your option to the <tt class="docutils literal"><span class="pre">user_options</span></tt> list attribute in the <tt class="docutils literal"><span class="pre">custom_install</span></tt> class. The <tt class="docutils literal"><span class="pre">user_options</span></tt> list contains tuples of three elements each. The first element is the option string name, the second element is typically <tt class="docutils literal"><span class="pre">None</span></tt>, and the third element is a brief description of the option to be printed for the <tt class="docutils literal"><span class="pre">--help</span></tt> option. An example of the creation of the <em class="xref std std-option">--newopt</em> option which can be assigned a numerical or string value from the command line is given as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">user_options</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="p">,</span>
                <span class="p">(</span><span class="s">&#39;newopt=&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;A new option which takes a string or numerical value&#39;</span><span class="p">),</span>
                <span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">Alternatively, if your option is a boolean option - for example, a binary switch to turn on/off the compilation of your <tt class="docutils literal"><span class="pre">openmoc.submodule</span></tt> extension module - you will need to define it in the <tt class="docutils literal"><span class="pre">boolean_options</span></tt> list attribute in the <tt class="docutils literal"><span class="pre">custom_install</span></tt> class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">boolean_options</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span>
                   <span class="s">&#39;newopt&#39;</span><span class="p">,</span>
                   <span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">Create a class attribute corresponding to your build option to the <tt class="docutils literal"><span class="pre">custom_install</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/setup.py</span></tt> file. The class attribute should have the same name and capitalization as the command line option. This should be done in the <tt class="docutils literal"><span class="pre">initialize_options(...)</span></tt> class method. An example is given for the boolean option case as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">initialize_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

  <span class="n">install</span><span class="o">.</span><span class="n">initialize_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="o">...</span>

  <span class="n">Set</span> <span class="n">a</span> <span class="n">default</span> <span class="n">value</span> <span class="k">for</span> <span class="n">the</span> <span class="n">new</span> <span class="n">build</span> <span class="n">option</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">newopt</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</div>
</li>
<li><p class="first">Inform the <tt class="docutils literal"><span class="pre">configuration</span></tt> class (given by the global <tt class="docutils literal"><span class="pre">config</span></tt> variable in <tt class="docutils literal"><span class="pre">setup.py</span></tt>) to use the value passed in for the build option. This may entail creating a new class attribute for the <tt class="docutils literal"><span class="pre">configuration</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file to account specifically for this option.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">finalize_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

  <span class="n">install</span><span class="o">.</span><span class="n">finalize_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="o">...</span>

  <span class="c"># Tell the configuration class what to do with the option</span>
  <span class="n">config</span><span class="o">.</span><span class="n">newopt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newopt</span>
</pre></div>
</div>
</li>
</ol>
<p>Once the build option is given to the <tt class="docutils literal"><span class="pre">configuration</span></tt> class, it is up to you to figure out what to do with it. The command line options are typically applied to the build configuration in the <tt class="docutils literal"><span class="pre">setup_extension_modules</span></tt> method for the <tt class="docutils literal"><span class="pre">configuration</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file as presented in the next section.</p>
</div>
<div class="section" id="inject-compiler-options">
<h3>3.5.5. Inject Compiler Options<a class="headerlink" href="#inject-compiler-options" title="Permalink to this headline">¶</a></h3>
<p>Although you created a list of compiler flags for your module in <a class="reference internal" href="#add-build-options"><em>Add Build Options</em></a>, they will not be used unless we expose them to the underlying distutils build system. We do this using the <tt class="docutils literal"><span class="pre">customize_compiler(...)</span></tt> routine in the <tt class="file docutils literal"><span class="pre">/OpenMOC/setup.py</span></tt> file. This routine overrides the <tt class="docutils literal"><span class="pre">_compile(...)</span></tt> routine in distutils and allows us to configure the compiler executable and compiler flags as we please. In particular, <tt class="docutils literal"><span class="pre">customize_compiler</span></tt> defines a new version of the <tt class="docutils literal"><span class="pre">_compile(...)</span></tt> method and <em>injects</em> it into distutils.</p>
<p>In order to ensure that distutils will use your compiler flags, you need to add a new conditional block to the <tt class="docutils literal"><span class="pre">_compile(...)</span></tt> method. This conditional should be able to determine when the <tt class="docutils literal"><span class="pre">_compile(...)</span></tt> method has received the build information for your extension module through its parameter set. One way to do this is to assign a specific macro to your build module which can be found in the <tt class="docutils literal"><span class="pre">pp_opts</span></tt> (pre-processing options) parameter to the <tt class="docutils literal"><span class="pre">_compile(...)</span></tt> method. for example, if you add a macro <span class="target" id="index-3"></span><tt class="xref std std-envvar docutils literal"><span class="pre">FIRST_MACRO</span></tt> which is unique and only used for your extension module, then you can look for it in <tt class="docutils literal"><span class="pre">pp_opts</span></tt> and configure the compiler when needed. An example of how this might be done in the <tt class="docutils literal"><span class="pre">_compile(...)</span></tt> routine is shown as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># If we find your macro, distutils is building your module</span>
<span class="k">if</span> <span class="s">&#39;-DFIRST_MACRO&#39;</span> <span class="ow">in</span> <span class="n">pp_opts</span><span class="p">:</span>

  <span class="c"># Set the compiler executable to the compiler</span>
  <span class="c"># you want to use for your module</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">set_executable</span><span class="p">(</span><span class="s">&#39;compiler_so&#39;</span><span class="p">,</span> <span class="s">&#39;gcc&#39;</span><span class="p">)</span>

  <span class="c"># Set the compiler flags</span>
  <span class="n">postargs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">compiler_flags</span><span class="p">[</span><span class="s">&#39;gcc&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="append-module-to-installation-packages">
<h3>3.5.6. Append Module to Installation Packages<a class="headerlink" href="#append-module-to-installation-packages" title="Permalink to this headline">¶</a></h3>
<p>Next, you must append the name of the module (<em>i.e.</em>, <tt class="docutils literal"><span class="pre">openmoc.submodule</span></tt>) to the <tt class="docutils literal"><span class="pre">packages</span></tt> list class attribute in the <tt class="docutils literal"><span class="pre">configuration</span></tt> class in the <tt class="file docutils literal"><span class="pre">/OpenMOC/config.py</span></tt> file. This will ensure that your new extension module will not only be compiled, but also installed into the directory with the rest of the OpenMOC shared library extension module(s) and Python modules. An example is as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;openmoc&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="s">&#39;openmoc.materialize&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="s">&#39;openmoc.submodule&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="create-swig-wrap-file">
<h3>3.5.7. Create SWIG Wrap File<a class="headerlink" href="#create-swig-wrap-file" title="Permalink to this headline">¶</a></h3>
<p>Your extension module C/C++ source files must be &#8220;wrapped&#8221; using SWIG to create a SWIG &#8220;wrap file.&#8221; The distutils package will automatically do this for most Python distributions, but in some cases it is not done properly. To account for the inconsistencies across platforms, the OpenMOC build system manually calls SWIG for each extension module we wish to build at compile time. In particular, the <tt class="docutils literal"><span class="pre">custom_build_ext(...)</span></tt> routine in the <tt class="file docutils literal"><span class="pre">/OpenMOC/setup.py</span></tt> file is used to directly call SWIG to wrap the source code for each extension module. An example of what one might append to the <tt class="docutils literal"><span class="pre">custom_build_ext(...)</span></tt> routine to wrap the source for the <tt class="docutils literal"><span class="pre">openmoc.submodule</span></tt> extension module might be the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="s">&#39;submodule&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">extensions</span><span class="p">:</span>
  <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;swig -python -c++ -keyword -o &#39;</span> <span class="o">+</span> \
            <span class="s">&#39;openmoc/submodule/openmoc_submodule_wrap.cpp &#39;</span> <span class="o">+</span> \
            <span class="s">&#39;openmoc/submodule/openmoc_submodule.i&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="create-an-extension-object">
<h3>3.5.8. Create an Extension Object<a class="headerlink" href="#create-an-extension-object" title="Permalink to this headline">¶</a></h3>
<p>The final step is to create an <tt class="docutils literal"><span class="pre">Extension</span></tt> object for your module in the <tt class="docutils literal"><span class="pre">setup_extension_modules(...)</span></tt> class method in the <tt class="docutils literal"><span class="pre">configuration</span></tt> class. The particular setup of your module is highly dependent on the functionality of your module and the build options added in the preceding steps. That said, there are several common issues to note when creating the <tt class="docutils literal"><span class="pre">Extension</span></tt> object.</p>
<p>First, the filename should begin with an underscore &#8220;_&#8221; since this is common practice for Python C/C++ extension modules. Second, the <tt class="docutils literal"><span class="pre">name</span></tt> parameter should be set to the filename of the shared library you wish to create. Typically, it is recommended that the shared library filename be constructed using the same words intended for the Python module, with &#8221;.&#8221; replaced by &#8220;_&#8221;. For example, to create the <tt class="docutils literal"><span class="pre">module.submodule.subsubmodule</span></tt> C/C++ extension module for Python, the shared library should be called <tt class="file docutils literal"><span class="pre">_module_submodule_subsubmodule.so</span></tt>. Finally, each of the parameters to the <tt class="docutils literal"><span class="pre">Extension</span></tt> object should be set using the lists of build options (<em>i.e.</em>, compiler flags, include libraries, etc.) configured in <a class="reference internal" href="#add-build-options"><em>Add Build Options</em></a>.</p>
<p>An example of how one might instantiate the <tt class="docutils literal"><span class="pre">Extension</span></tt> object in the <tt class="docutils literal"><span class="pre">setup_extension_modules(...)</span></tt> routine is given below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Create Extension object and append to the list of objects</span>
<span class="c"># in the configuration class</span>
<span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">submodule</span><span class="p">:</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="n">Extension</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;_openmoc_submodule&#39;</span><span class="p">,</span>
              <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="s">&#39;submodule&#39;</span><span class="p">],</span>
              <span class="n">library_dirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_directories</span><span class="p">[</span><span class="s">&#39;submodule&#39;</span><span class="p">],</span>
              <span class="n">libraries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_libraries</span><span class="p">[</span><span class="s">&#39;submodule&#39;</span><span class="p">],</span>
              <span class="n">extra_link_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linker_flags</span><span class="p">[</span><span class="s">&#39;submodule&#39;</span><span class="p">],</span>
              <span class="n">include_dirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_directories</span><span class="p">[</span><span class="s">&#39;submodule&#39;</span><span class="p">],</span>
              <span class="n">define_macros</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">[</span><span class="s">&#39;submodule&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">],</span>
              <span class="n">swig_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swig_flags</span><span class="p">,</span>
              <span class="n">export_symbols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;init_openmoc&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="section" id="python-package-tree">
<span id="id4"></span><h3>3.5.9. Python Package Tree<a class="headerlink" href="#python-package-tree" title="Permalink to this headline">¶</a></h3>
<p>Finally, you will need to create a directory tree to represent your module within the OpenMOC <a class="reference external" href="http://docs.python.org/2/tutorial/modules.html#packages">Python package</a>. For example, for the <tt class="docutils literal"><span class="pre">openmoc.submodule</span></tt> extension module, you would need to create the <tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/submodule</span></tt> directory. In addition, you will need to create a Python <tt class="file docutils literal"><span class="pre">__init__.py</span></tt> file, which is required for Python to treat the directory as a Python package. For a C/C++ extension module, the <tt class="file docutils literal"><span class="pre">__init__.py</span></tt> file typically will import the shared library (<em>i.e.</em>, <tt class="file docutils literal"><span class="pre">_openmoc_submodule.so</span></tt>) as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">_openmoc_submodule</span>

<span class="c"># Do any other initialization needed when</span>
<span class="c"># someone imports your module into Python</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You must create an <tt class="file docutils literal"><span class="pre">__init__.py</span></tt> file for each level of the Python package hierarchy. For example, for the <tt class="docutils literal"><span class="pre">openmoc.submodule.subsubmodule</span></tt>, you will need to create the <tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/submodule/__init__.py</span></tt> and <tt class="file docutils literal"><span class="pre">/OpenMOC/openmoc/submodule/subsubmodule/__init__.py</span></tt> files.</p>
</div>
</div>
<div class="section" id="build-the-extension-module">
<h3>3.5.10. Build the Extension Module<a class="headerlink" href="#build-the-extension-module" title="Permalink to this headline">¶</a></h3>
<p>FINALLY, you should be prepared to compile and install your C/C++ extension module using OpenMOC&#8217;s distutils-based build system!! The next step is to build OpenMOC as discussed in <a class="reference internal" href="../usersguide/install.html#install"><em>Installation and Configuration</em></a>, using the build option(s) which you defined for your module. For example, if you defined the build option <em class="xref std std-option">--newopt</em> as a binary option for building your module, you might run the following in the console:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>python setup.py install --user --newopt
</pre></div>
</div>
<p>This command should compile and install your shared library extension module in <tt class="file docutils literal"><span class="pre">/home/&lt;username&gt;/.local/lib/pythonX.X/site-packages/</span></tt> directory. In particular, you should be able to find the <tt class="file docutils literal"><span class="pre">_openmoc_submodule.so</span></tt> file in that directory, as well as the import directory tree for the module as presented in <a class="reference internal" href="#python-package-tree"><em>Python Package Tree</em></a> (<em>i.e.</em>, <tt class="file docutils literal"><span class="pre">/openmoc/submodule/</span></tt> with the <tt class="file docutils literal"><span class="pre">__init__.py</span></tt> file).</p>
<p>If all was properly configured as described in the preceding steps, you should be able to import your extension module into Python with the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">openmoc.submodule</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c"># Do cool things with your extension module here</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/openmoc-logo-sphinx-small.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3. Python Build System</a><ul>
<li><a class="reference internal" href="#configuration-file">3.1. Configuration File</a></li>
<li><a class="reference internal" href="#setup-file">3.2. Setup File</a><ul>
<li><a class="reference internal" href="#command-line-options">3.2.1. Command Line Options</a></li>
<li><a class="reference internal" href="#custom-compilers-and-linkers">3.2.2. Custom Compilers and Linkers</a></li>
<li><a class="reference internal" href="#building-and-installation">3.2.3. Building and Installation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#swig-interface-files">3.3. SWIG Interface Files</a></li>
<li><a class="reference internal" href="#common-modifications">3.4. Common Modifications</a><ul>
<li><a class="reference internal" href="#add-a-c-c-source-file">3.4.1. Add a C/C++ Source File</a></li>
<li><a class="reference internal" href="#add-a-python-module">3.4.2. Add a Python Module</a></li>
<li><a class="reference internal" href="#add-a-compiler-flag">3.4.3. Add a Compiler Flag</a></li>
<li><a class="reference internal" href="#add-a-linker-flag">3.4.4. Add a Linker Flag</a></li>
<li><a class="reference internal" href="#add-a-library-directory">3.4.5. Add a Library Directory</a></li>
<li><a class="reference internal" href="#add-an-include-directory">3.4.6. Add an Include Directory</a></li>
<li><a class="reference internal" href="#link-a-shared-library">3.4.7. Link a Shared Library</a></li>
<li><a class="reference internal" href="#add-a-macro-definition">3.4.8. Add a Macro Definition</a></li>
</ul>
</li>
<li><a class="reference internal" href="#add-a-c-c-extension-module">3.5. Add a C/C++ Extension Module</a><ul>
<li><a class="reference internal" href="#create-new-swig-interface-file">3.5.1. Create New SWIG Interface File</a></li>
<li><a class="reference internal" href="#add-source-files">3.5.2. Add Source Files</a></li>
<li><a class="reference internal" href="#add-build-options">3.5.3. Add Build Options</a></li>
<li><a class="reference internal" href="#add-a-build-option">3.5.4. Add a Build Option</a></li>
<li><a class="reference internal" href="#inject-compiler-options">3.5.5. Inject Compiler Options</a></li>
<li><a class="reference internal" href="#append-module-to-installation-packages">3.5.6. Append Module to Installation Packages</a></li>
<li><a class="reference internal" href="#create-swig-wrap-file">3.5.7. Create SWIG Wrap File</a></li>
<li><a class="reference internal" href="#create-an-extension-object">3.5.8. Create an Extension Object</a></li>
<li><a class="reference internal" href="#python-package-tree">3.5.9. Python Package Tree</a></li>
<li><a class="reference internal" href="#build-the-extension-module">3.5.10. Build the Extension Module</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="swig.html"
                        title="previous chapter">2. Simplified Wrapper Interface Generator (SWIG)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="debugging.html"
                        title="next chapter">4. Debugging OpenMOC</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/devguide/build_system.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="debugging.html" title="4. Debugging OpenMOC"
             >next</a> |</li>
        <li class="right" >
          <a href="swig.html" title="2. Simplified Wrapper Interface Generator (SWIG)"
             >previous</a> |</li>
        <li><a href="../index.html">OpenMOC Documentation</a> &raquo;</li>
          <li><a href="index.html" >Developer&#8217;s Guide</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
<<<<<<< HEAD
        &copy; Copyright 2012-2014, Massachusetts Institute of Technology.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.1.
=======
        &copy; Copyright 2012-2013, Massachusetts Institute of Technology.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
>>>>>>> 78b418280894e07bda3e689c29e4fd10bffe914b
    </div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30411614-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>